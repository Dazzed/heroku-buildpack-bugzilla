#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2

if [ -e "$BUILD_DIR/.perl-version" ]; then
  PERL_VERSION=`cat $BUILD_DIR/.perl-version`
else
  PERL_VERSION="5.16.3"
fi

echo $PERL_VERSION

PERL_PACKAGE="cache.bulknews.net/heroku/perl-$PERL_VERSION.tgz"
VENDORED_PERL="$BUILD_DIR/vendor/perl"

echo "-----> Vendoring Perl"
mkdir -p $VENDORED_PERL && curl $PERL_PACKAGE -s -o - | tar xzf - -C $VENDORED_PERL

export PATH="$BUILD_DIR/local/bin:$VENDORED_PERL/bin:$PATH"

echo "Using perl $PERL_VERSION" | indent

export PERL5LIB="$BUILD_DIR/local/lib/perl5"
export PERL_CPANM_OPT="--quiet --notest -l $BUILD_DIR/local"

LOCAL_DEPS="$BUILD_DIR/local"
CACHE_DEPS="$CACHE_DIR/$PERL_VERSION/local"

rm -rf $LOCAL_DEPS
if [ -d $CACHE_DEPS ]; then
  cp -R "$CACHE_DEPS" "$LOCAL_DEPS"
fi

cd $BUILD_DIR

if ! [ -e $LOCAL_DEPS/bin/cpanm ]; then
  echo "-----> Bootstrapping cpanm"
  curl --silent https://raw.github.com/miyagawa/cpanminus/master/cpanm | perl - App::cpanminus 2>&1 | indent
fi

echo "-----> Installing Carton"
cpanm --dev Carton 2>&1 | indent

echo "-----> Installing dependencies with Carton"
carton install --deployment 2>&1 | indent

echo "-----> Installing Starman"
cpanm Starman 2>&1 | indent

if [ -d "$LOCAL_DEPS" ]; then
  rm -rf "$CACHE_DEPS"
  mkdir -p "$CACHE_DIR"
  cp -R "$LOCAL_DEPS" "$CACHE_DEPS"
fi
